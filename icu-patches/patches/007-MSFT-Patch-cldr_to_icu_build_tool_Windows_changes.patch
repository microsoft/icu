From c47663533d1e63e844f9577254cda2563977b4e2 Mon Sep 17 00:00:00 2001
From: Daniel Ju <41210545+daniel-ju@users.noreply.github.com>
Date: Wed, 20 May 2020 17:11:55 -0700
Subject: [PATCH] Apply MSFT changes to the cldr-to-icu build tool.

---
 icu/icu/icu4c/source/data/build.xml           |  2 +-
 .../tools/cldr/cldr-to-icu/build-icu-data.xml |  6 ++++--
 .../icu/tool/cldrtoicu/LdmlConverter.java     |  3 ++-
 .../ant/CleanOutputDirectoryTask.java         |  6 ++++--
 .../cldrtoicu/ant/ConvertIcuDataTask.java     | 19 +++++++++++++------
 5 files changed, 24 insertions(+), 12 deletions(-)

diff --git a/icu/icu/icu4c/source/data/build.xml b/icu/icu/icu4c/source/data/build.xml
index 4b6f0929..d89dd1dc 100644
--- a/icu/icu/icu4c/source/data/build.xml
+++ b/icu/icu/icu4c/source/data/build.xml
@@ -43,7 +43,7 @@
         </condition>
         <fail unless="is.cldr.classes.set" message="CLDR classes not found in ${cldrtools.dir}. Please either set the CLDR_CLASSES environment variable or build cldr.jar."/>
 
-        <property name="env.CLDR_TMP_DIR" location="${env.CLDR_DIR}/../cldr-aux" /> <!-- Hack: see CLDRPaths -->
+        <property name="env.CLDR_TMP_DIR" location="${env.CLDR_DIR}/../cldr-staging" /> <!-- Hack: see CLDRPaths -->
         <property name="cldr.prod.dir" location="${env.CLDR_TMP_DIR}/production/" />
         <echo message="java home: ${java.home}"/>
         <echo message="java version: ${java.version}"/>
diff --git a/icu/icu/tools/cldr/cldr-to-icu/build-icu-data.xml b/icu/icu/tools/cldr/cldr-to-icu/build-icu-data.xml
index 518fa12d..f045753e 100644
--- a/icu/icu/tools/cldr/cldr-to-icu/build-icu-data.xml
+++ b/icu/icu/tools/cldr/cldr-to-icu/build-icu-data.xml
@@ -74,13 +74,15 @@
         <!-- Override to force the 'clean' task to delete files it cannot determine to be
              auto-generated by this tool. This is useful if the file header changes since
              the heading is what's used to recognize auto-generated files. -->
-        <property name="forceDelete" value="false"/>
+        <property name="forceDelete" value="true"/>
     </target>
 
     <!-- Build a standalone JAR which is called by Ant (and which avoids needing to mess
          about making Ant know the Maven class-path). -->
     <target name="prepare-jar" depends="init-args">
-        <exec executable="mvn" searchpath="true">
+        <!-- MSFT PATCH: Windows only searches for .exe executables by default, add the .cmd ext. 
+             https://ant.apache.org/manual/Tasks/exec.html -->
+        <exec executable="mvn.cmd" searchpath="true">
             <arg value="compile"/>
         </exec>
     </target>
diff --git a/icu/icu/tools/cldr/cldr-to-icu/src/main/java/org/unicode/icu/tool/cldrtoicu/LdmlConverter.java b/icu/icu/tools/cldr/cldr-to-icu/src/main/java/org/unicode/icu/tool/cldrtoicu/LdmlConverter.java
index 794f4100..e71baa77 100644
--- a/icu/icu/tools/cldr/cldr-to-icu/src/main/java/org/unicode/icu/tool/cldrtoicu/LdmlConverter.java
+++ b/icu/icu/tools/cldr/cldr-to-icu/src/main/java/org/unicode/icu/tool/cldrtoicu/LdmlConverter.java
@@ -238,7 +238,8 @@ private void convertAll() {
 
     private static ImmutableList<String> readLinesFromResource(String name) {
         try (InputStream in = LdmlConverter.class.getResourceAsStream(name)) {
-            return ImmutableList.copyOf(CharStreams.readLines(new InputStreamReader(in)));
+            // MSFT PATCH: Need to read in header file with UTF-8.
+            return ImmutableList.copyOf(CharStreams.readLines(new InputStreamReader(in, UTF_8)));
         } catch (IOException e) {
             throw new RuntimeException("cannot read resource: " + name, e);
         }
diff --git a/icu/icu/tools/cldr/cldr-to-icu/src/main/java/org/unicode/icu/tool/cldrtoicu/ant/CleanOutputDirectoryTask.java b/icu/icu/tools/cldr/cldr-to-icu/src/main/java/org/unicode/icu/tool/cldrtoicu/ant/CleanOutputDirectoryTask.java
index ddd34ea9..fe630ec9 100644
--- a/icu/icu/tools/cldr/cldr-to-icu/src/main/java/org/unicode/icu/tool/cldrtoicu/ant/CleanOutputDirectoryTask.java
+++ b/icu/icu/tools/cldr/cldr-to-icu/src/main/java/org/unicode/icu/tool/cldrtoicu/ant/CleanOutputDirectoryTask.java
@@ -100,8 +100,10 @@ public void init() throws BuildException {
     }
 
     @SuppressWarnings("unused")
-    public void setRoot(Path root) {
-        this.root = root;
+    public void setRoot(String root) {
+        // MSFT PATCH: Ant does not automagically convert arguments with type java.nio.file.Path.
+        // https://ant.apache.org/manual/develop.html
+        this.root = Paths.get(root);
     }
 
     @SuppressWarnings("unused")
diff --git a/icu/icu/tools/cldr/cldr-to-icu/src/main/java/org/unicode/icu/tool/cldrtoicu/ant/ConvertIcuDataTask.java b/icu/icu/tools/cldr/cldr-to-icu/src/main/java/org/unicode/icu/tool/cldrtoicu/ant/ConvertIcuDataTask.java
index 4fa66fcc..78b35ff1 100644
--- a/icu/icu/tools/cldr/cldr-to-icu/src/main/java/org/unicode/icu/tool/cldrtoicu/ant/ConvertIcuDataTask.java
+++ b/icu/icu/tools/cldr/cldr-to-icu/src/main/java/org/unicode/icu/tool/cldrtoicu/ant/ConvertIcuDataTask.java
@@ -16,6 +16,7 @@
 import static org.unicode.cldr.api.CldrPath.parseDistinguishingPath;
 
 import java.nio.file.Path;
+import java.nio.file.Paths;
 import java.util.ArrayList;
 import java.util.Arrays;
 import java.util.List;
@@ -76,13 +77,17 @@
     private Predicate<String> idFilter = id -> true;
 
     @SuppressWarnings("unused")
-    public void setOutputDir(Path path) {
-        config.setOutputDir(path);
+    public void setOutputDir(String path) {
+        // MSFT PATCH: Ant does not automagically convert arguments with type java.nio.file.Path.
+        // https://ant.apache.org/manual/develop.html
+        config.setOutputDir(Paths.get(path));
     }
 
     @SuppressWarnings("unused")
-    public void setCldrDir(Path path) {
-        this.cldrPath = checkNotNull(path);
+    public void setCldrDir(String path) {
+        // MSFT PATCH: Ant does not automagically convert arguments with type java.nio.file.Path.
+        // https://ant.apache.org/manual/develop.html
+        this.cldrPath = checkNotNull(Paths.get(path));
     }
 
     @SuppressWarnings("unused")
@@ -108,8 +113,10 @@ public void setOutputTypes(String types) {
     }
 
     @SuppressWarnings("unused")
-    public void setSpecialsDir(Path path) {
-        config.setSpecialsDir(path);
+    public void setSpecialsDir(String path) {
+        // MSFT PATCH: Ant does not automagically convert arguments with type java.nio.file.Path.
+        // https://ant.apache.org/manual/develop.html
+        config.setSpecialsDir(Paths.get(path));
     }
 
     @SuppressWarnings("unused")
-- 
2.20.1.vfs.1.1.104.g2ab7360

