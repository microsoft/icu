#####################################################################################################################################
#                                               OneBranch Pipelines - Official                                                      #
#####################################################################################################################################
#                                                                                                                                   #
# This pipeline builds ICU Nuget packages using OneBranch governed templates                                                        #
#                                                                                                                                   #
# Windows Undocked Wiki:        https://www.osgwiki.com/wiki/Windows_Undocked_Template                                              #
# General OB Documentation:     https://aka.ms/obpipelines                                                                          #
# Yaml Schema:                  https://aka.ms/obpipelines/yaml/schema                                                              #
# Retail Tasks:                 https://aka.ms/obpipelines/tasks                                                                    #
# Support:                      https://aka.ms/onebranchsup                                                                         #
#                                                                                                                                   #
#####################################################################################################################################

name: $(BuildDefinitionName)_$(date:yyMM).$(date:dd)$(rev:rrr)

trigger: none
pr: none

parameters:
- name: 'debug'
  displayName: 'Enable debug output'
  type: boolean
  default: false

variables:
  CDP_DEFINITION_BUILD_COUNT: $[counter('', 0)]
  system.debug: ${{ parameters.debug }}
  ENABLE_PRS_DELAYSIGN: 1
  ROOT: $(Build.SourcesDirectory)
  REPOROOT: $(Build.SourcesDirectory)
  OUTPUTROOT: $(REPOROOT)\out
  NUGET_XMLDOC_MODE: none
  BuildConfiguration: 'Release'
  nugetPackageName: 'Microsoft.ICU.ICU4C.Runtime'

  # Docker image for containerized builds
  WindowsContainerImage: 'onebranch.azurecr.io/windows/ltsc2019/vse2022:latest'
  LinuxContainerImage: 'onebranch.azurecr.io/linux/ubuntu-2004:latest'

resources:
  repositories: 
    - repository: templates
      type: git
      name: OneBranch.Pipelines/GovernedTemplates
      ref: refs/heads/main

extends:
  template: v2/Microsoft.Official.yml@templates
  parameters:
    platform:
      name: 'windows_undocked'
            
    cloudvault:
      enabled: false
    
    globalSdl:
      isNativeCode: true
      tsa:
        enabled: true
        configFile: '$(Build.SourcesDirectory)\.config\tsaoptions.json'
      # suppression:
      #   suppressionFile: $(Build.SourcesDirectory)\.gdn\global.gdnsuppress
    
    stages:
    #####################################################################
    # Build Stage - Windows
    #####################################################################
    - stage: BuildWindows
      displayName: 'Build Windows Binaries'
      jobs:
      - job: BuildWindows
        displayName: 'Build Windows'
        pool:
          type: windows
          name: Azure Pipelines
          demands:
          - msbuild
          - visualstudio
          - Cmd

        strategy:
          matrix:
            Win32:
              BuildPlatform: 'x86'
              IcuBuildPlatform: 'Win32'
            Win64:
              BuildPlatform: 'x64'
              IcuBuildPlatform: 'x64'
            ARM64:
              BuildPlatform: 'ARM64'
              IcuBuildPlatform: 'ARM64'

        variables:
          ob_outputDirectory: '$(BUILD.BINARIESDIRECTORY)\output\$(BuildPlatform)'
          ob_sdl_binskim_enabled: true
          ob_sdl_codeSignValidation_enabled: true
          ob_signing_enabled: true

        steps:
        - task: onebranch.pipeline.version@1
          displayName: 'Setup BuildNumber'
          inputs:
            system: 'RevisionCounter'
            major: '1'
            minor: '0'
            exclude_commit: true

        - task: ms.vss-governance-buildtask.governance-build-task-component-detection.ComponentGovernanceComponentDetection@0
          displayName: 'Component Detection'

        - task: PowerShell@2
          displayName: 'Set ICU Version'
          inputs:
            targetType: filePath
            filePath: './build/scripts/Set-ICUVersion.ps1'
            arguments: '-icuVersionFile "$(BUILD.SOURCESDIRECTORY)\version.txt"'

        # The ARM/ARM64 builds for ICU require the x64 tools in order to cross-build
        - task: VSBuild@1
          displayName: 'Build x64 first (Only if building ARM)'
          inputs:
            solution: icu/icu4c/source/allinone/allinone.sln
            msbuildArgs: '/p:SkipUWP=true'
            platform: x64
            configuration: Release
          condition: eq(variables['IcuBuildPlatform'],'ARM64')

        - task: VSBuild@1
          displayName: 'Build $(BuildPlatform)'
          inputs:
            solution: icu/icu4c/source/allinone/allinone.sln
            msbuildArgs: '/p:SkipUWP=true'
            platform: '$(IcuBuildPlatform)'
            configuration: Release

        # Copy binaries to output directory
        - task: CopyFiles@2
          displayName: 'Copy x64 DLLs'
          inputs:
            Contents: |
              icu\icu4c\bin64\icuuc*.dll
              icu\icu4c\bin64\icuin*.dll
              icu\icu4c\bin64\icudt*.dll
            TargetFolder: '$(ob_outputDirectory)'
            flattenFolders: true
          condition: eq(variables['BuildPlatform'],'x64')

        - task: CopyFiles@2
          displayName: 'Copy ARM64 DLLs'
          inputs:
            Contents: |
              icu\icu4c\binARM64\icuuc*.dll
              icu\icu4c\binARM64\icuin*.dll
              icu\icu4c\binARM64\icudt*.dll
            TargetFolder: '$(ob_outputDirectory)'
            flattenFolders: true
          condition: eq(variables['BuildPlatform'],'ARM64')

        - task: CopyFiles@2
          displayName: 'Copy x86 DLLs'
          inputs:
            Contents: |
              icu\icu4c\bin\icuuc*.dll
              icu\icu4c\bin\icuin*.dll
              icu\icu4c\bin\icudt*.dll
            TargetFolder: '$(ob_outputDirectory)'
            flattenFolders: true
          condition: eq(variables['BuildPlatform'],'x86')

        # Sanity check for ICU data DLL size
        - task: PowerShell@2
          displayName: 'Check ICU Data DLL'
          inputs:
            targetType: 'inline'
            script: |
              Write-Host 'Checking the size of the ICU data DLL...'
              if ((Get-Item "$(ob_outputDirectory)\icudt*.dll").length -lt 5KB) {
                  throw 'Error: The ICU data DLL file appears to be too small.'
              }

        # Copy symbols (PDBs) for publishing
        - task: CopyFiles@2
          displayName: 'Copy symbols x64'
          inputs:
            Contents: |
              icu\icu4c\lib64\icuuc*.pdb
              icu\icu4c\lib64\icuin*.pdb
              icu\icu4c\lib64\icudt*.pdb
            TargetFolder: '$(BUILD.BINARIESDIRECTORY)\symbols\$(BuildPlatform)'
            flattenFolders: true
          condition: eq(variables['BuildPlatform'],'x64')

        - task: CopyFiles@2
          displayName: 'Copy symbols ARM64'
          inputs:
            Contents: |
              icu\icu4c\libARM64\icuuc*.pdb
              icu\icu4c\libARM64\icuin*.pdb
              icu\icu4c\libARM64\icudt*.pdb
            TargetFolder: '$(BUILD.BINARIESDIRECTORY)\symbols\$(BuildPlatform)'
            flattenFolders: true
          condition: eq(variables['BuildPlatform'],'ARM64')

        - task: CopyFiles@2
          displayName: 'Copy symbols x86'
          inputs:
            Contents: |
              icu\icu4c\lib\icuuc*.pdb
              icu\icu4c\lib\icuin*.pdb
              icu\icu4c\lib\icudt*.pdb
            TargetFolder: '$(BUILD.BINARIESDIRECTORY)\symbols\$(BuildPlatform)'
            flattenFolders: true
          condition: eq(variables['BuildPlatform'],'x86')

        # Publish symbols as separate artifact
        - task: PublishPipelineArtifact@1
          displayName: 'Publish symbols'
          inputs:
            targetPath: '$(BUILD.BINARIESDIRECTORY)\symbols\$(BuildPlatform)'
            artifact: 'symbols-win-$(BuildPlatform)'
            publishLocation: 'pipeline'

    #####################################################################
    # Build Stage - Linux
    #####################################################################
    - stage: BuildLinux
      displayName: 'Build Linux Binaries'
      jobs:
      - job: BuildLinux
        displayName: 'Build Linux'
        pool:
          type: linux
          name: Azure Pipelines
          vmImage: 'ubuntu-latest'

        strategy:
          matrix:
            x64:
              distro: 'centos'
              BuildPlatform: 'x64'
            arm64:
              distro: 'ubuntu-arm64'
              BuildPlatform: 'arm64'

        variables:
          ob_outputDirectory: '$(BUILD.BINARIESDIRECTORY)/output/$(BuildPlatform)'

        steps:
        - task: onebranch.pipeline.version@1
          displayName: 'Setup BuildNumber'
          inputs:
            system: 'RevisionCounter'
            major: '1'
            minor: '0'
            exclude_commit: true

        - task: PowerShell@2
          displayName: 'Set ICU Version'
          inputs:
            targetType: filePath
            filePath: './build/scripts/Set-ICUVersion.ps1'
            arguments: '-icuVersionFile "$(BUILD.SOURCESDIRECTORY)/version.txt"'

        - task: Docker@2
          displayName: 'Setup Docker Container: $(distro)'
          inputs:
            command: build
            Dockerfile: 'build/dockerfiles/$(distro)/Dockerfile'
            arguments: -t ms-icu-container-$(BuildPlatform)

        - script: |
            pwd && mkdir -p /tmp/build-output && docker run --rm -v $(pwd):/src -v /tmp/build-output:/dist ms-icu-container-$(BuildPlatform) /src/build/scripts/build-icu-$(BuildPlatform).sh
          displayName: 'Configure ICU and Build'

        # Copy .so files
        - script: |
            mkdir -p $(ob_outputDirectory)
            ls -al /tmp/build-output/icu/usr/local/lib/
            cp /tmp/build-output/icu/usr/local/lib/libicudata.so.$(ICUVersion) $(ob_outputDirectory)
            cp /tmp/build-output/icu/usr/local/lib/libicui18n.so.$(ICUVersion) $(ob_outputDirectory)
            cp /tmp/build-output/icu/usr/local/lib/libicuuc.so.$(ICUVersion) $(ob_outputDirectory)
          displayName: 'Copy .so files'

        # Copy debug symbols
        - script: |
            mkdir -p $(BUILD.BINARIESDIRECTORY)/symbols/$(BuildPlatform)
            ls -al /tmp/build-output/icu/usr/local/lib/
            cp /tmp/build-output/icu/usr/local/lib/libicudata.so.$(ICUVersion).debug $(BUILD.BINARIESDIRECTORY)/symbols/$(BuildPlatform)
            cp /tmp/build-output/icu/usr/local/lib/libicui18n.so.$(ICUVersion).debug $(BUILD.BINARIESDIRECTORY)/symbols/$(BuildPlatform)
            cp /tmp/build-output/icu/usr/local/lib/libicuuc.so.$(ICUVersion).debug $(BUILD.BINARIESDIRECTORY)/symbols/$(BuildPlatform)
          displayName: 'Copy debug symbols'

        - task: PublishPipelineArtifact@1
          displayName: 'Publish symbols'
          inputs:
            targetPath: '$(BUILD.BINARIESDIRECTORY)/symbols/$(BuildPlatform)'
            artifact: 'symbols-linux-$(BuildPlatform)'
            publishLocation: 'pipeline'

    #####################################################################
    # Create Nuget Package Stage
    #####################################################################
    - stage: CreateNuget
      displayName: 'Create Nuget Package'
      dependsOn:
      - BuildWindows
      - BuildLinux
      jobs:
      - job: CreateNuget
        displayName: 'Create Nuget Package'
        pool:
          type: windows
          name: Azure Pipelines

        variables:
          ob_outputDirectory: '$(BUILD.BINARIESDIRECTORY)\output\nuget'
          ob_sdl_binskim_enabled: false
          ob_signing_enabled: true
          ob_signing_tsa: true

        steps:
        - task: onebranch.pipeline.version@1
          displayName: 'Setup BuildNumber'
          inputs:
            system: 'RevisionCounter'
            major: '1'
            minor: '0'
            exclude_commit: true

        - task: PowerShell@2
          displayName: 'Set ICU Version'
          inputs:
            targetType: filePath
            filePath: './build/scripts/Set-ICUVersion.ps1'
            arguments: '-icuVersionFile "$(BUILD.SOURCESDIRECTORY)\version.txt"'

        - task: NuGetToolInstaller@1
          displayName: 'Install NuGet'

        # Download all build artifacts
        - task: DownloadPipelineArtifact@2
          displayName: 'Download Windows Binaries'
          inputs:
            artifact: 'drop_BuildWindows_BuildWindows'
            path: '$(Build.BINARIESDIRECTORY)\bits\win'

        - task: DownloadPipelineArtifact@2
          displayName: 'Download Linux Binaries'
          inputs:
            artifact: 'drop_BuildLinux_BuildLinux'
            path: '$(Build.BINARIESDIRECTORY)\bits\linux'

        - task: PowerShell@2
          displayName: 'Organize binaries for Nuget creation'
          inputs:
            targetType: 'inline'
            script: |
              # Organize binaries into expected structure
              $bitsPath = "$(Build.BINARIESDIRECTORY)\bits"
              
              # Create platform directories
              New-Item -ItemType Directory -Force -Path "$bitsPath\win-x86"
              New-Item -ItemType Directory -Force -Path "$bitsPath\win-x64"
              New-Item -ItemType Directory -Force -Path "$bitsPath\win-ARM64"
              New-Item -ItemType Directory -Force -Path "$bitsPath\linux-x64"
              New-Item -ItemType Directory -Force -Path "$bitsPath\linux-arm64"
              
              # Copy Windows binaries
              Copy-Item "$bitsPath\win\x86\*" "$bitsPath\win-x86\" -Force
              Copy-Item "$bitsPath\win\x64\*" "$bitsPath\win-x64\" -Force
              Copy-Item "$bitsPath\win\ARM64\*" "$bitsPath\win-ARM64\" -Force
              
              # Copy Linux binaries
              Copy-Item "$bitsPath\linux\x64\*" "$bitsPath\linux-x64\" -Force
              Copy-Item "$bitsPath\linux\arm64\*" "$bitsPath\linux-arm64\" -Force
              
              Write-Host "Binaries organized successfully"
              Get-ChildItem -Recurse $bitsPath | Format-Table Name, Length

        - task: PowerShell@2
          displayName: 'Create MS-ICU Nuget'
          inputs:
            targetType: filePath
            filePath: './build/scripts/Create-Nuget-Runtime.ps1'
            arguments: '-sourceRoot $(BUILD.SOURCESDIRECTORY) -icuBinaries "$(BUILD.BINARIESDIRECTORY)\bits" -output $(ob_outputDirectory) -codesign true'

        - task: onebranch.pipeline.signing@1
          displayName: 'Sign Nuget Package'
          inputs:
            command: 'sign'
            signing_profile: 'external_distribution'
            files_to_sign: '**/*.nupkg'
            search_root: '$(ob_outputDirectory)\package'

    #####################################################################
    # Publish Symbols Stage
    #####################################################################
    - stage: PublishSymbols
      displayName: 'Publish Symbols'
      dependsOn:
      - BuildWindows
      - CreateNuget
      condition: succeeded()
      jobs:
      - job: PublishSymbols
        displayName: 'Publish to Symbol Server'
        pool:
          type: windows
          name: Azure Pipelines

        variables:
          ob_outputDirectory: '$(BUILD.BINARIESDIRECTORY)\symbols'

        steps:
        - task: PowerShell@2
          displayName: 'Set ICU Version'
          inputs:
            targetType: filePath
            filePath: './build/scripts/Set-ICUVersion.ps1'
            arguments: '-icuVersionFile "$(BUILD.SOURCESDIRECTORY)\version.txt"'

        # Download symbol artifacts
        - task: DownloadPipelineArtifact@2
          displayName: 'Download Windows Symbols'
          inputs:
            patterns: 'symbols-win-*/**'
            path: '$(BUILD.BINARIESDIRECTORY)\symbols'

        - task: PublishSymbols@2
          displayName: 'Publish symbols to public server'
          inputs:
            symbolsFolder: '$(BUILD.BINARIESDIRECTORY)\symbols'
            searchPattern: '**/*.pdb'
            SymbolsMaximumWaitTime: 30
            SymbolServerType: 'TeamServices'
            SymbolsProduct: 'MS-ICU Nuget Windows binaries'
            SymbolsVersion: '$(ICUVersion)'
            indexSources: false
            detailedLog: true
          env:
            LIB: $(Build.SourcesDirectory)
            ArtifactServices_Symbol_AccountName: microsoftpublicsymbols
            ArtifactServices_Symbol_PAT: $(MSICU_microsoftpublicsymbols_PAT)
