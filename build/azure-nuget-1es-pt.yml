# Nuget Build Pipeline - 1ES Pipeline Template
# This pipeline uses 1ES Pipeline Templates for GitHub public repos with peer review

# no PR triggers (1ES PT supports manual triggers for GitHub scenarios with peer review)
pr: none
trigger: none

variables:
  codeSign: ${{ eq(variables['System.definitionId'], '1386') }}
  BuildConfiguration: 'Release'
  nugetPackageName: 'Microsoft.ICU.ICU4C.Runtime'

resources:
  repositories:
    - repository: 1ESPipelineTemplates
      type: git
      name: 1ESPipelineTemplates/1ESPipelineTemplates
      ref: refs/tags/release

extends:
  template: v1/1ES.Official.PipelineTemplate.yml@1ESPipelineTemplates
  parameters:
    pool:
      name: Azure-Pipelines-1ESPT-ExDShared
      os: windows
      image: windows-2022
    
    sdl:
      sourceAnalysisPool:
        name: Azure-Pipelines-1ESPT-ExDShared
        os: windows
        image: windows-2022
      enableContinuousCompliance: true

    stages:
    - stage: Build
      jobs:
      - job: BuildLinux
        pool:
          name: Azure-Pipelines-1ESPT-ExDShared
          os: linux
          image: ubuntu-latest
        workspace:
          clean: all

        strategy:
          matrix:
            centos:
              distro: 'centos'
              BuildPlatform: 'x64'
            arm64:
              distro: 'ubuntu-arm64'
              BuildPlatform: 'arm64'

        steps:
          - checkout: self
            lfs: true
            fetchDepth: 1

          - task: PowerShell@2
            displayName: 'Set ICU Version'
            inputs:
              targetType: filePath
              filePath: './build/scripts/Set-ICUVersion.ps1'
              arguments: '-icuVersionFile "$(BUILD.SOURCESDIRECTORY)\version.txt"'
          
          - script: |
              docker build \
                -t ms-icu-container-$(BuildPlatform) \
                -f build/dockerfiles/$(distro)/Dockerfile .
            displayName: 'Build Docker image (script)'

          - script: |
              pwd && mkdir -p /tmp/build-output && docker run --rm -v $(pwd):/src -v /tmp/build-output:/dist ms-icu-container-$(BuildPlatform) /src/build/scripts/build-icu-$(BuildPlatform).sh
            displayName: 'Configure ICU and Build'

          - script: |
              cd /tmp/build-output && ls -Rl
            displayName: 'DIAG: ls -Rl'

          # Note: We only copy the .so files with the full version (ex: libicuuc.so.67.1.0.4)
          - script: |
              mkdir /tmp/icu-binaries
              ls -al /tmp/build-output/icu/usr/local/lib/
              cp /tmp/build-output/icu/usr/local/lib/libicudata.so.$(ICUVersion) /tmp/icu-binaries
              cp /tmp/build-output/icu/usr/local/lib/libicui18n.so.$(ICUVersion) /tmp/icu-binaries
              cp /tmp/build-output/icu/usr/local/lib/libicuuc.so.$(ICUVersion) /tmp/icu-binaries
            displayName: 'Copy .so files'

          - task: 1ES.PublishPipelineArtifact@1
            displayName: 'Publish: binaries'
            inputs:
              targetPath: '/tmp/icu-binaries'
              artifactName: 'linux-$(BuildPlatform)'

          - script: |
              mkdir /tmp/icu-symbols
              ls -al /tmp/build-output/icu/usr/local/lib/
              cp /tmp/build-output/icu/usr/local/lib/libicudata.so.$(ICUVersion).debug /tmp/icu-symbols
              cp /tmp/build-output/icu/usr/local/lib/libicui18n.so.$(ICUVersion).debug /tmp/icu-symbols
              cp /tmp/build-output/icu/usr/local/lib/libicuuc.so.$(ICUVersion).debug /tmp/icu-symbols
            displayName: 'Copy debug symbols'

          - task: 1ES.PublishPipelineArtifact@1
            displayName: 'Publish: symbols'
            inputs:
              targetPath: '/tmp/icu-symbols'
              artifactName: 'Symbols-$(nugetPackageName).linux-$(BuildPlatform)'

      - job: BuildWindows
        timeoutInMinutes: 60
        pool:
          name: Azure Pipelines
          os: windows
          image: windows-2022
        workspace:
          clean: all

        # Note: The VS uses "Win32" for 32-bit arch, but we use x86 in the pipeline.
        # This matrix strategy lets us build the different architectures in parallel.
        strategy:
          matrix:
            Win32:
              BuildPlatform: 'x86'
              IcuBuildPlatform: 'Win32'
            Win64:
              BuildPlatform: 'x64'
              IcuBuildPlatform: 'x64'
            ARM64:
              BuildPlatform: 'ARM64'
              IcuBuildPlatform: 'ARM64'
        
        steps:
        - checkout: self
          lfs: true
          fetchDepth: 1

        - powershell: |
            $PublishBinariesName = ""
            if ($env:codeSign -ieq 'true') {
              $PublishBinariesName = "binaries-$env:BuildPlatform"
            } else {
              $PublishBinariesName = "win-$env:BuildPlatform"
            }
            Write-Host PublishBinariesName = $PublishBinariesName
            Write-Host "##vso[task.setvariable variable=PublishBinariesName]$PublishBinariesName"
          displayName: 'Set PublishBinariesName variable'

        - task: PowerShell@2
          displayName: 'Set ICU Version'
          inputs:
            targetType: filePath
            filePath: './build/scripts/Set-ICUVersion.ps1'
            arguments: '-icuVersionFile "$(BUILD.SOURCESDIRECTORY)\version.txt"'

        # The ARM/ARM64 builds for ICU require the x64 tools in order to cross-build.
        - task: VSBuild@1
          displayName: 'Build x64 first (Only if building ARM)'
          inputs:
            solution: icu/icu4c/source/allinone/allinone.sln
            msbuildArgs: '/p:SkipUWP=true'
            platform: x64
            configuration: Release
          condition: eq(variables['IcuBuildPlatform'],'ARM64')

        - task: VSBuild@1
          displayName: 'Build $(BuildPlatform)'
          inputs:
            solution: icu/icu4c/source/allinone/allinone.sln
            msbuildArgs: '/p:SkipUWP=true'
            platform: '$(IcuBuildPlatform)'
            configuration: Release

        # Binaries (DLLs)
        - task: CopyFiles@2
          displayName: 'Copy x64'
          inputs:
            Contents: |
              icu\icu4c\bin64\icuuc*.dll
              icu\icu4c\bin64\icuin*.dll
              icu\icu4c\bin64\icudt*.dll
            TargetFolder: '$(Build.ArtifactStagingDirectory)\$(BuildPlatform)'
            flattenFolders: true
          condition: eq(variables['BuildPlatform'],'x64')

        - task: CopyFiles@2
          displayName: 'Copy ARM64'
          inputs:
            Contents: |
              icu\icu4c\binARM64\icuuc*.dll
              icu\icu4c\binARM64\icuin*.dll
              icu\icu4c\binARM64\icudt*.dll
            TargetFolder: '$(Build.ArtifactStagingDirectory)\$(BuildPlatform)'
            flattenFolders: true
          condition: eq(variables['BuildPlatform'],'ARM64')

        - task: CopyFiles@2
          displayName: 'Copy x86'
          inputs:
            Contents: |
              icu\icu4c\bin\icuuc*.dll
              icu\icu4c\bin\icuin*.dll
              icu\icu4c\bin\icudt*.dll
            TargetFolder: '$(Build.ArtifactStagingDirectory)\$(BuildPlatform)'
            flattenFolders: true
          condition: eq(variables['BuildPlatform'],'x86')

        # This is a sanity check to ensure that we have the real data DLL, and not the stubdata DLL.
        - powershell: |
            Write-Host 'Checking the size of the ICU data DLL...'
            if ((Get-Item "$(Build.ArtifactStagingDirectory)\$(BuildPlatform)\icudt*.dll").length -lt 5KB) {
                throw 'Error: The ICU data DLL file appears to be too small.'
            }
          displayName: 'Check ICU Data DLL'

        - task: 1ES.PublishPipelineArtifact@1
          displayName: 'Publish: binaries'
          inputs:
            targetPath: '$(Build.ArtifactStagingDirectory)\$(BuildPlatform)'
            artifactName: '$(PublishBinariesName)'

        # Symbols (PDBs)
        - task: CopyFiles@2
          displayName: 'Copy symbols x64'
          inputs:
            Contents: |
              icu\icu4c\lib64\icuuc*.pdb
              icu\icu4c\lib64\icuin*.pdb
              icu\icu4c\lib64\icudt*.pdb
            TargetFolder: '$(Build.ArtifactStagingDirectory)\symbols-$(BuildPlatform)'
            flattenFolders: true
          condition: eq(variables['BuildPlatform'],'x64')

        - task: CopyFiles@2
          displayName: 'Copy symbols ARM64'
          inputs:
            Contents: |
              icu\icu4c\libARM64\icuuc*.pdb
              icu\icu4c\libARM64\icuin*.pdb
              icu\icu4c\libARM64\icudt*.pdb
            TargetFolder: '$(Build.ArtifactStagingDirectory)\symbols-$(BuildPlatform)'
            flattenFolders: true
          condition: eq(variables['BuildPlatform'],'ARM64')

        - task: CopyFiles@2
          displayName: 'Copy symbols x86'
          inputs:
            Contents: |
              icu\icu4c\lib\icuuc*.pdb
              icu\icu4c\lib\icuin*.pdb
              icu\icu4c\lib\icudt*.pdb
            TargetFolder: '$(Build.ArtifactStagingDirectory)\symbols-$(BuildPlatform)'
            flattenFolders: true
          condition: eq(variables['BuildPlatform'],'x86')

        - task: 1ES.PublishPipelineArtifact@1
          displayName: 'Publish: symbols'
          inputs:
            targetPath: '$(Build.ArtifactStagingDirectory)\symbols-$(BuildPlatform)'
            artifactName: 'symbols-win-$(BuildPlatform)'

    - stage: CodeSignBinaries
      condition: and(succeeded(), eq(variables.codeSign, true))
      dependsOn: Build
      jobs:
      - job: CodeSignBits
        timeoutInMinutes: 60
        pool:
          name: Azure Pipelines
          os: windows
          image: windows-2022
        workspace:
          clean: all
        variables:
          signingPattern: 'icudt*.dll;icuuc*.dll;icuin*.dll'

        # This matrix strategy lets us code-sign the architectures in parallel.
        strategy:
          matrix:
            Win32:
              BuildPlatform: 'x86'
            Win64:
              BuildPlatform: 'x64'
            ARM64:
              BuildPlatform: 'ARM64'
        
        steps:
        - checkout: self
          lfs: true
          fetchDepth: 1

        - task: PowerShell@2
          displayName: 'Set Version'
          inputs:
            targetType: filePath
            filePath: './build/scripts/Set-ICUVersion.ps1'
            arguments: '-icuVersionFile "$(BUILD.SOURCESDIRECTORY)\version.txt"'

        - task: DownloadPipelineArtifact@2
          displayName: 'Download: Binaries'
          inputs:
            artifact: 'binaries-$(BuildPlatform)'
            path: '$(Build.ArtifactStagingDirectory)\bits\binaries-$(BuildPlatform)'

        - powershell: |
            Write-Host ""
            Write-Host "$(BUILD.BINARIESDIRECTORY)"
            Tree /F /A $(BUILD.BINARIESDIRECTORY)
            Write-Host ""
            Write-Host "$(BUILD.ArtifactStagingDirectory)"
            Tree /F /A $(BUILD.ArtifactStagingDirectory)
          displayName: 'DIAG: dir'
        
        - task: EsrpCodeSigning@5
          displayName: 'ESRP CodeSigning - CodeSign DLLs'
          inputs:
            ConnectedServiceName: 'ESRP Code Signing for MS-ICU (2026)'
            UseMSIAuthentication: true
            AppRegistrationClientId: '8773af57-7743-45cb-8556-92b3a41c39e0'
            AppRegistrationTenantId: '33e01921-4d64-4f8c-a055-5bdaffd5e33d'
            EsrpClientId: "8bc7108f-a254-4863-8e93-175eedff03cc"
            AuthAKVName: 'icukv'
            AuthSignCertName: 'msicuesrp'
            FolderPath: '$(BUILD.ArtifactStagingDirectory)\bits\binaries-$(BuildPlatform)'
            Pattern: '*.dll'
            ServiceEndpointUrl: 'https://api.esrp.microsoft.com/api/v2'
            signConfigType: 'inlineSignParams'
            inlineOperation: |
              [
              
                {
                  "KeyCode": "CP-230012",
                  "OperationCode": "SigntoolSign",
                  "Parameters": {
                    "OpusName": "Microsoft",
                    "OpusInfo": "http://www.microsoft.com",
                    "PageHash": "/NPH",
                    "FileDigest": "/fd sha256",
                    "TimeStamp": "/tr \"http://rfc3161.gtm.corp.microsoft.com/TSS/HttpTspServer\" /td sha256"
                  },
                  "ToolName": "signtool.exe",
                  "ToolVersion": "6.2.9304.0"
                }
              ]
            SessionTimeout: '30'
            MaxConcurrency: '20'
            MaxRetryAttempts: '5'

        - task: 1ES.PublishPipelineArtifact@1
          displayName: 'Publish: binaries signed'
          inputs:
            targetPath: '$(Build.ArtifactStagingDirectory)\bits\binaries-$(BuildPlatform)'
            artifactName: 'win-$(BuildPlatform)'

    - stage: CreateNuget
      dependsOn:
      - Build
      - CodeSignBinaries
      # This stage needs to depend on CodeSignBinaries for the Release-Nuget pipeline, but it will be skipped in the CI-Nuget pipeline.
      condition: and(in(dependencies.Build.result, 'Succeeded'), in(dependencies.CodeSignBinaries.result, 'Succeeded', 'Skipped'))
      jobs:
      - job: CreateNugetJob
        timeoutInMinutes: 30
        pool:
          name: Azure Pipelines
          os: windows
          image: windows-2022
        workspace:
          clean: all
        variables:
          BuildPlatform: AnyCPU

        steps:
        - checkout: self
          lfs: true
          fetchDepth: 1

        - task: PowerShell@2
          displayName: 'Set Version'
          inputs:
            targetType: filePath
            filePath: './build/scripts/Set-ICUVersion.ps1'
            arguments: '-icuVersionFile "$(BUILD.SOURCESDIRECTORY)\version.txt"'

        - task: NuGetToolInstaller@1
          displayName: 'Install NuGet'

        - powershell: |
            Write-Host ""
            Write-Host "$(BUILD.BINARIESDIRECTORY)"
            Tree /F /A $(BUILD.BINARIESDIRECTORY)
          displayName: 'DIAG: dir'

        # Binaries (.dll or .so files)
        - task: DownloadPipelineArtifact@2
          displayName: 'Download win-x86'
          inputs:
            artifact: 'win-x86'
            path: '$(Build.BINARIESDIRECTORY)\bits\win-x86'

        - task: DownloadPipelineArtifact@2
          displayName: 'Download win-x64'
          inputs:
            artifact: 'win-x64'
            path: '$(Build.BINARIESDIRECTORY)\bits\win-x64'

        - task: DownloadPipelineArtifact@2
          displayName: 'Download win-ARM64'
          inputs:
            artifact: 'win-ARM64'
            path: '$(Build.BINARIESDIRECTORY)\bits\win-ARM64'

        - task: DownloadPipelineArtifact@2
          displayName: 'Download linux-x64'
          inputs:
            artifact: 'linux-x64'
            path: '$(Build.BINARIESDIRECTORY)\bits\linux-x64'

        - task: DownloadPipelineArtifact@2
          displayName: 'Download linux-arm64'
          inputs:
            artifact: 'linux-arm64'
            path: '$(Build.BINARIESDIRECTORY)\bits\linux-arm64'

        - powershell: |
            Write-Host ""
            Write-Host "$(BUILD.BINARIESDIRECTORY)"
            Tree /F /A $(BUILD.BINARIESDIRECTORY)
            Write-Host ""
            Write-Host "$(BUILD.SOURCESDIRECTORY)"
            Tree /F /A $(BUILD.SOURCESDIRECTORY)
          displayName: 'DIAG: dir'

        - task: PowerShell@2
          displayName: 'Create MS-ICU Nuget'
          inputs:
            targetType: filePath
            filePath: './build/scripts/Create-Nuget-Runtime.ps1'
            arguments: '-sourceRoot $(BUILD.SOURCESDIRECTORY) -icuBinaries "$(BUILD.BINARIESDIRECTORY)\bits" -output $(BUILD.ArtifactStagingDirectory)\output -codesign $(codeSign)'

        - powershell: |
            Write-Host ""
            Write-Host "$(BUILD.ArtifactStagingDirectory)"
            Tree /F /A $(BUILD.ArtifactStagingDirectory)
          displayName: 'DIAG: dir'

        - task: 1ES.PublishPipelineArtifact@1
          displayName: 'Publish: Nuget Packages'
          inputs:
            targetPath: '$(BUILD.ArtifactStagingDirectory)\output\package'
            artifactName: 'Nuget_Packages'

    - stage: CodeSignNuget
      dependsOn:
      - Build
      - CodeSignBinaries
      - CreateNuget
      condition: and(eq(variables.codeSign, true), and(in(dependencies.CodeSignBinaries.result, 'Succeeded'), in(dependencies.CreateNuget.result, 'Succeeded')))
      jobs:
      - job: CodeSignNugetJob
        timeoutInMinutes: 60
        pool:
          name: Azure Pipelines
          os: windows
          image: windows-2022
        workspace:
          clean: all
        variables:
          BuildPlatform: AnyCPU

        steps:
        - checkout: self
          lfs: true
          fetchDepth: 1

        - task: PowerShell@2
          displayName: 'Set Version'
          inputs:
            targetType: filePath
            filePath: './build/scripts/Set-ICUVersion.ps1'
            arguments: '-icuVersionFile "$(BUILD.SOURCESDIRECTORY)\version.txt"'

        - task: NuGetToolInstaller@1
          displayName: 'Install NuGet'

        - task: DownloadPipelineArtifact@2
          displayName: 'Download Nuget'
          inputs:
            artifact: 'Nuget_Packages'
            path: '$(BUILD.ArtifactStagingDirectory)\nuget\Nuget_Packages'

        - powershell: |
            Write-Host ""
            Write-Host "$(BUILD.ArtifactStagingDirectory)"
            Tree /F /A $(BUILD.ArtifactStagingDirectory)
          displayName: 'DIAG: dir'
        
        - powershell: |
            Write-Host "SigningPattern is: '$(signingPattern)'" 
          displayName: 'DIAG: show signing pattern'

        - task: EsrpCodeSigning@5
          displayName: 'ESRP CodeSigning - CodeSign DLLs'
          inputs:
            ConnectedServiceName: 'ESRP Code Signing for MS-ICU (2026)'
            UseMSIAuthentication: true
            AppRegistrationClientId: '8773af57-7743-45cb-8556-92b3a41c39e0'
            AppRegistrationTenantId: '33e01921-4d64-4f8c-a055-5bdaffd5e33d'
            EsrpClientId: "8bc7108f-a254-4863-8e93-175eedff03cc"
            AuthAKVName: 'icukv'
            AuthSignCertName: 'msicuesrp'
            FolderPath: '$(BUILD.ArtifactStagingDirectory)\nuget\Nuget_Packages'
            Pattern: |
              *.nupkg
            UseMinimatch: true
            signConfigType: 'inlineSignParams'
            ServiceEndpointUrl: 'https://api.esrp.microsoft.com/api/v2'
            inlineOperation: |
              [
                {
                  "KeyCode" : "CP-401405",
                  "OperationCode" : "NuGetSign",
                  "Parameters" : {},
                  "ToolName" : "sign",
                  "ToolVersion" : "1.0"
                },
                {
                    "KeyCode" : "CP-401405",
                    "OperationCode" : "NuGetVerify",
                    "Parameters" : {},
                    "ToolName" : "sign",
                    "ToolVersion" : "1.0"
                }
              ]
            SessionTimeout: '30'
            MaxConcurrency: '20'
            MaxRetryAttempts: '5'

        - powershell: |
            Write-Host ""
            Write-Host "$(BUILD.ArtifactStagingDirectory)"
            Tree /F /A $(BUILD.ArtifactStagingDirectory)
          displayName: 'DIAG: dir'
        
        - task: 1ES.PublishPipelineArtifact@1
          displayName: 'Publish: Nuget Packages'
          inputs:
            targetPath: '$(BUILD.ArtifactStagingDirectory)\nuget\Nuget_Packages'
            artifactName: 'Nuget_Packages_Signed'

        # Symbols (PDBs)
        - task: DownloadPipelineArtifact@2
          displayName: 'Download symbols-win-x86'
          inputs:
            artifact: 'symbols-win-x86'
            path: '$(Build.BINARIESDIRECTORY)\symbols\symbols-win-x86'

        - task: DownloadPipelineArtifact@2
          displayName: 'Download symbols-win-x64'
          inputs:
            artifact: 'symbols-win-x64'
            path: '$(Build.BINARIESDIRECTORY)\symbols\symbols-win-x64'

        - task: DownloadPipelineArtifact@2
          displayName: 'Download symbols-win-ARM64'
          inputs:
            artifact: 'symbols-win-ARM64'
            path: '$(Build.BINARIESDIRECTORY)\symbols\symbols-win-ARM64'
        
        - powershell: |
            Write-Host ""
            Write-Host "$(BUILD.BINARIESDIRECTORY)"
            Tree /F /A $(BUILD.BINARIESDIRECTORY)
          displayName: 'DIAG: dir'

        # Publish the Windows Symbols to the public MSDL symbol server.
        # Accessible via https://msdl.microsoft.com/download/symbols
        - task: PublishSymbols@2
          displayName: 'Publish symbols to public server (no source indexing)'
          inputs:
            symbolsFolder: '$(Build.BINARIESDIRECTORY)\symbols'
            searchPattern: '**/*.pdb'
            SymbolsMaximumWaitTime: 30
            SymbolServerType: 'TeamServices'
            SymbolsProduct: 'MS-ICU Nuget Windows binaries'
            SymbolsVersion: '$(ICUVersion)'
          # The ADO task does not support indexing of GitHub sources.
            indexSources: false
            detailedLog: true
          # There is a bug which causes this task to fail if LIB includes an inaccessible path (even though it does not depend on it).
          # To work around this issue, we just force LIB to be any dir that we know exists.
          env:
            LIB: $(Build.SourcesDirectory)
            ArtifactServices_Symbol_AccountName: microsoftpublicsymbols
            ArtifactServices_Symbol_PAT: $(MSICU_microsoftpublicsymbols_PAT)
